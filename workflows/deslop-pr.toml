# De-Slop PR Workflow
# Quick slop detection and cleanup for PR descriptions

[workflow]
name = "deslop-pr"
description = "Detect and remove AI-generated patterns from PR descriptions"

[[phases]]
id = "gather"
prompt = """
# Gather Phase

Locate the PR description to review.

## Finding the PR

Check these locations in order:
1. User-provided path (if specified in request)
2. Existing PR on current branch: `gh pr view --json body -q .body`
3. Draft PR file in plan directory
4. Common locations: `PR.md`, `pr-description.md`, `.github/pull_request_template.md`

## Diff Context

Get the diff to understand what the PR is describing:
```bash
BASE=$(git merge-base origin/main HEAD 2>/dev/null || git merge-base origin/master HEAD)
git diff $BASE..HEAD > full.diff
git log --oneline $BASE..HEAD > commits.txt
```

## Output

Write `context.md` with:
- Path to PR description (or note if from `gh pr view`)
- Number of commits
- Files changed count
- The full PR description text
"""
suggested_next = [
    { phase = "detect", instruction = "PR data gathered — scan for slop" }
]

[[phases]]
id = "detect"
use_tasks = true
prompt = """
# Detect Phase

Scan the PR description for slop patterns.

## Setup

Create tasks.json with a single slop detection task:

```json
[
  {
    "id": "slop-scan",
    "description": "Scan PR description for AI-generated patterns",
    "prompt_file": "slop-detection",
    "subagent": "general-purpose",
    "model": "haiku",
    "steps": [
      "Read context.md to get PR description",
      "Apply slop detection patterns from instructions",
      "Focus on prose patterns (not code patterns)",
      "Output findings grouped by severity"
    ],
    "status": "todo"
  }
]
```

## Inputs

- context.md with PR description text

## Focus Areas

For PR descriptions, prioritize these patterns:
- AI vocabulary words (delve, utilize, leverage, ensure, robust)
- Hazy importance claims ("emphasizing the significance...")
- Throat-clearing ("In order to", "It's worth noting")
- Summary addiction (restating the title)
- Marketing speak and vague claims
- Passive voice overuse
- Em-dash abuse

## Output

Write `findings.md` with slop patterns found, grouped by severity.
Include line references and specific examples.
"""
suggested_next = [
    { phase = "fix", instruction = "Slop patterns identified — present fixes to user" }
]

[[phases]]
id = "fix"
requires_user_input = true
prompt = """
# Fix Phase

Present findings and let user select which fixes to apply.

## Inputs

- context.md with original PR description
- findings.md with detected slop patterns

## Process

1. **Read findings.md** and parse the slop patterns found

2. **Present findings using AskUserQuestion** with multiSelect checkboxes:

   Use the AskUserQuestion tool with `multiSelect: true` to let the user choose which fixes to apply.

   Example:
   ```json
   {
     "questions": [{
       "question": "Which slop patterns should I fix?",
       "header": "Fixes",
       "multiSelect": true,
       "options": [
         {"label": "Line 5: utilize → use", "description": "Replace AI vocabulary word"},
         {"label": "Line 12: In order to → To", "description": "Remove throat-clearing"},
         {"label": "Line 18: remove hazy claim", "description": "Delete 'underscoring the importance of'"},
         {"label": "Line 23: passive → active", "description": "Rewrite in active voice"}
       ]
     }]
   }
   ```

   Group by severity if there are many findings:
   - HIGH severity fixes in first question
   - MEDIUM/LOW in second question (if needed)

   Limit to 4 options per question (AskUserQuestion constraint). If more findings exist,
   prioritize HIGH severity and note that additional LOW severity items are in findings.md.

3. **Apply selected fixes** using Edit tool on the PR file

4. **Show before/after** for each fix applied

5. **If PR is from `gh pr view`**, offer to update:
   ```bash
   gh pr edit --body-file cleaned-pr.md
   ```

## Output

Write `cleaned-pr.md` with the de-slopped PR description.

Present summary:
```
De-slop complete:
- X patterns found
- Y fixes applied
- Original: [path or "GitHub PR #N"]
- Cleaned: cleaned-pr.md
```
"""
terminal = true
