# PR Review Workflow
# Review and improve an existing PR description

[workflow]
name = "pr-review"
description = "Review an existing PR description for quality and accuracy"

[[phases]]
id = "gather"
prompt = """
# Gather Phase

Collect the PR document and code context for review.

## Inputs

The user should provide a path to the PR document to review.

## Base Branch Detection

To verify the PR accurately describes the changes, we need the actual diff.

**Important:** Always diff against the **merge-base commit** (where the branch forked), not the tip of the base branch.

Determine the base branch:
1. Check for the default branch (main/master)
2. If multiple candidate branches exist (feature-off-feature scenario), ask the user

Compute the merge-base:
```bash
MERGE_BASE=$(git merge-base $BASE_BRANCH HEAD)
```

## Tasks

1. Locate and read the PR document to review
2. Determine base branch and compute merge-base
3. Generate diff for context:
   - `full.diff` (git diff $MERGE_BASE..HEAD)
   - `commit-log.txt` (git log --oneline $MERGE_BASE..HEAD)
   - `file-manifest.txt` with structured file list

## File Manifest Format

Tab-separated columns: status, adds, dels, path

Generate via:
```bash
git diff $MERGE_BASE..HEAD --numstat | while read adds dels path; do
  status=$(git diff --name-status $MERGE_BASE..HEAD -- "$path" 2>/dev/null | head -1 | cut -f1)
  echo -e "$status\t$adds\t$dels\t$path"
done
```

## Outputs

Write `review-context.md` with:
- Path to PR document being reviewed
- Branch being reviewed
- Base branch and merge-base commit
- Files changed summary
"""
suggested_next = [
    { phase = "review", instruction = "PR data gathered — begin review" }
]

[[phases]]
id = "review"
use_tasks = true
required_tasks = [
  { id = "pr-slop-detection", description = "Scan PR for AI-generated writing patterns", subagent = "general-purpose", prompt_file = "slop-detection", model = "haiku" },
  { id = "accuracy-check", description = "Verify PR claims against actual diff", subagent = "general-purpose", subagent_prompt = "Verify PR claims: Are all major changes mentioned? Any inaccurate or misleading claims? Does summary match the code? Are file references correct?", model = "opus" },
  { id = "gemini-editorial-review", description = "Gemini review for clarity and completeness", subagent = "gemini-reviewer", subagent_prompt = "Check: clarity, completeness, logical organization, appropriate detail level, missing context, whether motivation is clear" },
  { id = "codex-technical-review", description = "Codex review for technical accuracy", subagent = "codex-reviewer", subagent_prompt = "Check: technical accuracy, correct terminology, missing implementation details, testing section adequacy, consistency between summary and changes" },
  { id = "reader-comprehension", description = "Review for reader understanding", subagent = "general-purpose", subagent_prompt = "Check: Would unfamiliar reviewer understand? Is review tour helpful? Any unanswered questions? Is PR self-contained?", model = "opus" },
  { id = "synthesize-feedback", description = "Synthesize all feedback into review-feedback.md", parents = ["pr-slop-detection", "accuracy-check", "gemini-editorial-review", "codex-technical-review", "reader-comprehension"] },
]
prompt = """
# Review Phase

Review the PR description from multiple perspectives.

## Inputs

- review-context.md for context
- The PR document (path from review-context.md)
- full.diff for verifying accuracy

## Outputs

Write `review-feedback.md` with feedback from all reviewers, organized by source.
"""
suggested_next = [
    { phase = "synthesize", instruction = "Reviews complete — synthesize findings" }
]

[[phases]]
id = "synthesize"
prompt = """
# Synthesize Phase

Combine feedback into actionable recommendations.

## Inputs

- review-context.md for context
- review-feedback.md for all reviewer feedback
- The original PR document

## Feedback Synthesis

For each finding:
1. Categorize as ACCEPT or DISCARD

**ACCEPT criteria:**
- Factual inaccuracy
- Missing important information
- Slop patterns that hurt readability
- Clarity issues that would confuse reviewers

**DISCARD criteria:**
- Style preferences without clear benefit
- Pedantic corrections
- Already addressed in another section

## Output Format

Write `pr-recommendations.md` with:

```markdown
## PR Review Summary

**Document:** [path]
**Branch:** [branch-name]

### Critical Issues
[Must fix - inaccuracies, missing critical info]

### Suggested Improvements
[Should consider - clarity, organization, completeness]

### Minor Nits
[Optional - style, wording tweaks]

### What's Good
[Positive observations - what the PR does well]

---

## Specific Edits

For each recommended change:

### [Issue Title]
**Location:** [Section or line reference]
**Current:** [What it says now]
**Suggested:** [What it should say]
**Rationale:** [Why this change improves the PR]
```

Include specific, actionable edit suggestions.
"""
suggested_next = [
    { phase = "complete", instruction = "Synthesis complete — finalize review" }
]

[[phases]]
id = "complete"
prompt = """
# Complete Phase

Finalize and present the PR review.

## Inputs

- pr-recommendations.md

## Tasks

1. Present the review summary to the user
2. Highlight critical issues that need addressing
3. Offer to help implement suggested edits

## Presentation Format

```markdown
## PR Review Complete

**Document reviewed:** [path]

### Summary

[Brief overview of PR quality]

### Action Items

1. [Critical issues to fix]
2. [Suggested improvements]

### Next Steps

- Review recommendations in `pr-recommendations.md`
- Apply suggested edits to improve the PR
- Re-run review if significant changes are made
```

This is a terminal phase. The PR review is complete.
"""
terminal = true
