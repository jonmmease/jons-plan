# Design Workflow
# For research projects, design decisions, and exploratory work

[workflow]
name = "design"
description = "Research, explore, and produce a design document"

[[phases]]
id = "research-planning"
prompt_files = ["research-planning"]
context_artifacts = ["research-brief", "research"]
required_artifacts = ["research-plan"]
prompt = """
## Tasks

1. Identify what needs to be researched for this topic
2. List specific questions to answer
3. Identify sources (codebase, web, docs, prototyping)

## Exploration Angles to Consider

- **Codebase patterns** — Existing implementations, architectural conventions, file organization
- **External approaches** — Web research on best practices, libraries, how others solve this
- **Requirements analysis** — Constraints, edge cases, acceptance criteria
- **Prototyping** — Quick spikes to validate assumptions
- **API/library research** — Documentation, capabilities, integration patterns

## Outputs

Write `research-plan.md` with:
- Questions to answer (grouped by domain)
- Sources to consult
- Research task assignments
"""
suggested_next = [
    { phase = "research", instruction = "Research plan ready — begin research" }
]

[[phases]]
id = "research"
use_tasks = true
supports_prototypes = true
supports_cache_reference = true
context_artifacts = ["research-plan", "research"]
required_artifacts = ["research"]
prompt = """
# Research Phase

Execute the research plan (injected above).

If prior research findings are injected above (from a previous iteration), build on them — add new findings without removing existing content.

## Tasks

Launch exploration agents. **You decide** how many agents to launch and what each explores based on the topic's complexity.

Launch agents appropriately:
- Run independent explorations in parallel for speed
- Chain explorations that depend on each other
- Use more agents for complex topics with many angles
- Use fewer for focused topics with clear scope

## Model Selection

| Task Type | Model |
|-----------|-------|
| Codebase research | `opus` |
| External API/library/web research | `haiku` |
| Prototyping spike | `sonnet` |
| Trade-off analysis | `opus` |

## Outputs

Write findings to `research.md`:
- Current state of the codebase
- External resources and references
- Identified constraints
- Potential approaches with pros/cons

Use prototype tasks if you need to answer questions through implementation.

If this is a subsequent iteration, append new findings to the existing research.md content.
"""
suggested_next = [
    { phase = "evaluate-research", instruction = "Research complete — evaluate findings" }
]

[[phases]]
id = "evaluate-research"
max_retries = 4
prompt_files = ["evaluate-research"]
context_artifacts = ["research-plan", "research"]
suggested_next = [
    { phase = "draft", instruction = "All questions adequately answered" },
    { phase = "research-planning", instruction = "Significant gaps remain — plan additional research for unanswered questions" }
]

[[phases]]
id = "draft"
use_tasks = true
dual_planning = true
context_artifacts = ["research"]
required_artifacts = ["design"]
required_tasks = [
  { id = "opus-planning", description = "Generate design document via Opus", prompt_file = "dual-planning", model = "opus", inject_phase_prompt = true, context_artifacts = ["research"] },
  { id = "codex-planning", description = "Generate design document via Codex CLI", prompt_file = "dual-planning", executor = "codex-cli", inject_phase_prompt = true, inject_project_context = true, context_artifacts = ["research"] },
  { id = "synthesize-plans", description = "Judge and merge both designs", prompt_file = "plan-synthesis", parents = ["opus-planning", "codex-planning"], model = "opus" },
]
prompt = """
# Draft Phase

Create the initial design document with confidence assessment based on the research findings (injected above).

## Planning Tasks

1. Synthesize research findings into a coherent design
2. Choose an approach and justify the decision
3. Document the proposed architecture/solution
4. Identify risks and mitigation strategies
5. Assess confidence (1-5 scale)

## Confidence Assessment Format

Include this section at the end of `design.md`:

```markdown
## Confidence Assessment

**Overall Score: [1-5]**

| Dimension | Score | Explanation |
|-----------|-------|-------------|
| Feasibility | [1-5] | Can this be implemented with the current codebase? |
| Scope | [1-5] | Is the scope well-defined and achievable? |
| Technical Risk | [1-5] | Are there unknowns or risky assumptions? |

**Areas of Uncertainty:**
- [List specific uncertainties to resolve via review]

**Questions for Reviewers:**
- [Specific questions you want external reviewers to address]
```

## Checkpoint

**If overall confidence score is below 4**, STOP and discuss concerns with the user before proceeding:
- Present the confidence assessment
- List specific concerns and dimensions
- Ask for guidance: proceed anyway, investigate further, or pivot

## Outputs

Write `design.md` with:
- Problem statement
- Proposed solution
- Architecture/design details
- Implementation considerations
- Risk assessment
- Confidence assessment

Output filename: design.md
"""
suggested_next = [
    { phase = "complete", instruction = "Design synthesized — finalize" }
]

[[phases]]
id = "complete"
prompt = """
# Complete Phase

Finalize the design document.

## Tasks

1. Review final design.md
2. Ensure all feedback is addressed
3. Document next steps if implementation is desired

## Design Document Checklist

- [ ] Problem statement is clear
- [ ] Proposed solution is fully described
- [ ] Trade-offs are documented
- [ ] Risks and mitigations are identified
- [ ] Confidence assessment is included
- [ ] Feedback has been addressed

This is a terminal phase. The design workflow is complete.
"""
terminal = true
