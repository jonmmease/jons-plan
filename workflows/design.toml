# Design Workflow
# For research projects, design decisions, and exploratory work

[workflow]
name = "design"
description = "Research, explore, and produce a design document"

[[phases]]
id = "research-planning"
prompt_files = ["research-planning"]
context_artifacts = ["research"]
required_artifacts = ["research-plan"]
prompt = """
## Tasks

1. Identify what needs to be researched for this topic
2. List specific questions to answer
3. Identify sources (codebase, web, docs, prototyping)

## Exploration Angles to Consider

- **Codebase patterns** — Existing implementations, architectural conventions, file organization
- **External approaches** — Web research on best practices, libraries, how others solve this
- **Requirements analysis** — Constraints, edge cases, acceptance criteria
- **Prototyping** — Quick spikes to validate assumptions
- **API/library research** — Documentation, capabilities, integration patterns

## Outputs

Write `research-plan.md` with:
- Questions to answer (grouped by domain)
- Sources to consult
- Research task assignments
"""
suggested_next = [
    { phase = "research", instruction = "Research plan ready — begin research" }
]

[[phases]]
id = "research"
use_tasks = true
supports_prototypes = true
supports_cache_reference = true
context_artifacts = ["research-plan", "research"]
required_artifacts = ["research"]
prompt = """
# Research Phase

Execute the research plan (injected above).

If prior research findings are injected above (from a previous iteration), build on them — add new findings without removing existing content.

## Tasks

Launch exploration agents. **You decide** how many agents to launch and what each explores based on the topic's complexity.

Launch agents appropriately:
- Run independent explorations in parallel for speed
- Chain explorations that depend on each other
- Use more agents for complex topics with many angles
- Use fewer for focused topics with clear scope

## Model Selection

| Task Type | Model |
|-----------|-------|
| Codebase research | `opus` |
| External API/library/web research | `haiku` |
| Prototyping spike | `sonnet` |
| Trade-off analysis | `opus` |

## Outputs

Write findings to `research.md`:
- Current state of the codebase
- External resources and references
- Identified constraints
- Potential approaches with pros/cons

Use prototype tasks if you need to answer questions through implementation.

If this is a subsequent iteration, append new findings to the existing research.md content.
"""
suggested_next = [
    { phase = "evaluate-research", instruction = "Research complete — evaluate findings" }
]

[[phases]]
id = "evaluate-research"
max_retries = 4
prompt_files = ["evaluate-research"]
context_artifacts = ["research-plan", "research"]
suggested_next = [
    { phase = "draft", instruction = "All questions adequately answered" },
    { phase = "research-planning", instruction = "Significant gaps remain — plan additional research for unanswered questions" }
]

[[phases]]
id = "draft"
context_artifacts = ["research"]
required_artifacts = ["design"]
prompt = """
# Draft Phase

Create the initial design document with confidence assessment based on the research findings (injected above).

## Tasks

1. Synthesize research findings into a coherent design
2. Choose an approach and justify the decision
3. Document the proposed architecture/solution
4. Identify risks and mitigation strategies
5. Assess confidence (1-5 scale)

## Confidence Assessment Format

Include this section at the end of `design.md`:

```markdown
## Confidence Assessment

**Overall Score: [1-5]**

| Dimension | Score | Explanation |
|-----------|-------|-------------|
| Feasibility | [1-5] | Can this be implemented with the current codebase? |
| Scope | [1-5] | Is the scope well-defined and achievable? |
| Technical Risk | [1-5] | Are there unknowns or risky assumptions? |

**Areas of Uncertainty:**
- [List specific uncertainties to resolve via review]

**Questions for Reviewers:**
- [Specific questions you want external reviewers to address]
```

## Checkpoint

**If overall confidence score is below 4**, STOP and discuss concerns with the user before proceeding:
- Present the confidence assessment
- List specific concerns and dimensions
- Ask for guidance: proceed anyway, investigate further, or pivot

## Outputs

Write `design.md` with:
- Problem statement
- Proposed solution
- Architecture/design details
- Implementation considerations
- Risk assessment
- Confidence assessment
"""
suggested_next = [
    { phase = "review", instruction = "Draft ready — send for external review" }
]

[[phases]]
id = "review"
prompt_files = ["selective-re-review"]
context_artifacts = ["design", "review-feedback"]
required_artifacts = ["review-feedback"]
prompt = """
# Review Phase

Get external feedback on the design.

## Tasks

1. Launch gemini-reviewer agent to review design.md (skip on re-review if no unresolved Critical items from gemini)
2. Launch codex-reviewer agent for second opinion (skip on re-review if no unresolved Critical items from codex)
3. Collect and organize feedback with severity levels

**Important for reviewer tasks:**
- Do NOT include `model` field (reviewers use their own external models)
- Do NOT include `subagent_prompt` field (not used for reviewers)

## Outputs

Write `review-feedback.md` with severity-tagged items:

```markdown
# Review Feedback

## Source: gemini-reviewer

### Critical
- [Issue that must be addressed before proceeding]

### Suggestion
- [Would improve the design but not blocking]

### Nit
- [Minor style or preference issue]

## Source: codex-reviewer

### Critical
- [...]

### Suggestion
- [...]

### Nit
- [...]
```
"""
suggested_next = [
    { phase = "revise", instruction = "Feedback received — incorporate changes" }
]

[[phases]]
id = "revise"
context_artifacts = ["design", "review-feedback"]
required_artifacts = ["design"]
prompt_files = ["revise"]
prompt = """
## Inputs

- design.md (injected above)
- review-feedback.md (injected above)

## Tasks

1. Update design.md with all accepted changes
2. Write investigation findings if any INVESTIGATE items existed
3. Update confidence assessment

## Outputs

Updated design.md with:
- Addressed feedback
- Investigation findings (if any)
- Updated confidence score (1-5) with rationale
"""
suggested_next = [
    { phase = "evaluate-revisions", instruction = "Revisions complete — evaluate changes" }
]

[[phases]]
id = "evaluate-revisions"
max_retries = 2
prompt_files = ["evaluate-revisions"]
context_artifacts = ["design", "review-feedback"]
suggested_next = [
    { phase = "complete", instruction = "All critical items resolved" },
    { phase = "review", instruction = "Critical items remain unresolved — re-engage only reviewers with unresolved Critical items" },
    { phase = "research", instruction = "Fundamental issues require rethinking the approach", requires_approval = true, approval_prompt = "Return to research for fundamental rethinking of the approach?" }
]

[[phases]]
id = "complete"
prompt = """
# Complete Phase

Finalize the design document.

## Tasks

1. Review final design.md
2. Ensure all feedback is addressed
3. Document next steps if implementation is desired

## Design Document Checklist

- [ ] Problem statement is clear
- [ ] Proposed solution is fully described
- [ ] Trade-offs are documented
- [ ] Risks and mitigations are identified
- [ ] Confidence assessment is included
- [ ] Feedback has been addressed

This is a terminal phase. The design workflow is complete.
"""
terminal = true
