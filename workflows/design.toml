# Design Workflow
# For research projects, design decisions, and exploratory work

[workflow]
name = "design"
description = "Research, explore, and produce a design document"

[[phases]]
id = "research-planning"
context_artifacts = ["research"]
required_artifacts = ["research-plan"]
prompt = """
# Research Planning Phase

Plan the research before diving in.

## Prior Research

If prior research findings are injected above (from a previous iteration), review them to identify what's already been answered. Focus the new research plan on unanswered questions only.

## Tasks

1. Identify what needs to be researched for this topic
2. List specific questions to answer
3. Identify sources (codebase, web, docs, prototyping)

## Exploration Angles to Consider

- **Codebase patterns** — Existing implementations, architectural conventions, file organization
- **External approaches** — Web research on best practices, libraries, how others solve this
- **Requirements analysis** — Constraints, edge cases, acceptance criteria
- **Prototyping** — Quick spikes to validate assumptions
- **API/library research** — Documentation, capabilities, integration patterns

## Outputs

Write `research-plan.md` with:
- Questions to answer (grouped by domain)
- Sources to consult
- Research task assignments
"""
suggested_next = ["research"]

[[phases]]
id = "research"
use_tasks = true
supports_prototypes = true
supports_cache_reference = true
context_artifacts = ["research-plan", "research"]
required_artifacts = ["research"]
prompt = """
# Research Phase

Execute the research plan (injected above).

If prior research findings are injected above (from a previous iteration), build on them — add new findings without removing existing content.

## Tasks

Launch exploration agents. **You decide** how many agents to launch and what each explores based on the topic's complexity.

Launch agents appropriately:
- Run independent explorations in parallel for speed
- Chain explorations that depend on each other
- Use more agents for complex topics with many angles
- Use fewer for focused topics with clear scope

## Model Selection

| Task Type | Model |
|-----------|-------|
| Codebase research | `opus` |
| External API/library/web research | `haiku` |
| Prototyping spike | `sonnet` |
| Trade-off analysis | `opus` |

## Outputs

Write findings to `research.md`:
- Current state of the codebase
- External resources and references
- Identified constraints
- Potential approaches with pros/cons

Use prototype tasks if you need to answer questions through implementation.

If this is a subsequent iteration, append new findings to the existing research.md content.
"""
suggested_next = ["evaluate-research"]

[[phases]]
id = "evaluate-research"
max_retries = 4
context_artifacts = ["research-plan", "research"]
prompt = """
# Evaluate Research Phase

Evaluate whether the research adequately answers the questions from the research plan.

## Process

1. Read the research plan (injected above) and list each question
2. Read the research findings (injected above)
3. For each question, assess: answered, partially answered, or unanswered

## Decision

- If all questions are adequately answered: transition to **draft**
- If significant gaps remain: transition to **research-planning** to plan additional research
"""
suggested_next = ["draft", "research-planning"]

[[phases]]
id = "draft"
context_artifacts = ["research"]
required_artifacts = ["design"]
prompt = """
# Draft Phase

Create the initial design document with confidence assessment based on the research findings (injected above).

## Tasks

1. Synthesize research findings into a coherent design
2. Choose an approach and justify the decision
3. Document the proposed architecture/solution
4. Identify risks and mitigation strategies
5. Assess confidence (1-5 scale)

## Confidence Assessment Format

Include this section at the end of `design.md`:

```markdown
## Confidence Assessment

**Overall Score: [1-5]**

| Dimension | Score | Explanation |
|-----------|-------|-------------|
| Feasibility | [1-5] | Can this be implemented with the current codebase? |
| Scope | [1-5] | Is the scope well-defined and achievable? |
| Technical Risk | [1-5] | Are there unknowns or risky assumptions? |

**Areas of Uncertainty:**
- [List specific uncertainties to resolve via review]

**Questions for Reviewers:**
- [Specific questions you want external reviewers to address]
```

## Checkpoint

**If overall confidence score is below 4**, STOP and discuss concerns with the user before proceeding:
- Present the confidence assessment
- List specific concerns and dimensions
- Ask for guidance: proceed anyway, investigate further, or pivot

## Outputs

Write `design.md` with:
- Problem statement
- Proposed solution
- Architecture/design details
- Implementation considerations
- Risk assessment
- Confidence assessment
"""
suggested_next = ["review"]

[[phases]]
id = "review"
prompt = """
# Review Phase

Get external feedback on the design.

## Tasks

1. Launch gemini-reviewer agent to review design.md
2. Launch codex-reviewer agent for second opinion
3. Collect and organize feedback

**Important for reviewer tasks:**
- Do NOT include `model` field (reviewers use their own external models)
- Do NOT include `subagent_prompt` field (not used for reviewers)

## Outputs

Write `review-feedback.md` using this format:

```markdown
# Review Feedback

## Source: gemini-reviewer

### ACCEPT
- [Feedback point]: [How this will be addressed]

### INVESTIGATE
- [Feedback point]: [Question that needs exploration]
  - Domain: codebase|technical|requirements
  - Specific question: "[Precise question for an explore agent]"

### REJECT
- [Feedback point]: [Why this doesn't apply or is incorrect]

## Source: codex-reviewer

### ACCEPT
- [...]

### INVESTIGATE
- [...]

### REJECT
- [...]

## Investigation Questions Summary

**Codebase questions:**
- [Question 1]

**Technical questions:**
- [Question 1]

**Requirements questions:**
- [Question 1]
```
"""
suggested_next = ["revise"]

[[phases]]
id = "revise"
requires_user_input = true
prompt = """
# Revise Phase

Incorporate feedback and finalize the design.

## Inputs

- design.md from draft phase
- review-feedback.md from review phase

## Tasks

1. Address all ACCEPT items by updating design.md
2. For INVESTIGATE items:
   - Launch `opus` exploration agents for each question
   - Write findings to `investigation-findings.md`
   - Update design based on findings
3. Document rationale for REJECT items (brief note is fine)
4. Update confidence assessment

## Investigation Findings Format

If investigations were needed:

```markdown
# Investigation Findings

## Question: [Original question]
**Domain:** codebase|technical|requirements
**Finding:** [What was discovered]
**Impact on Design:** [How this affects the design]
**Recommendation:** accept-feedback|reject-feedback|modify-approach
```

## Final Confidence Check

After incorporating feedback, re-assess confidence (1-5).

**If final confidence score is below 4**, STOP and discuss with the user:
- Present updated confidence assessment
- Explain what concerns remain
- Ask: create design anyway, discuss concerns, or abandon

## Outputs

Updated design.md with:
- Addressed feedback
- Investigation findings (if any)
- Final confidence score (1-5) with rationale
"""
suggested_next = [
    "complete",
    "revise",
    { phase = "research", requires_approval = true, approval_prompt = "Return to research for fundamental rethinking of the approach?" }
]

[[phases]]
id = "complete"
prompt = """
# Complete Phase

Finalize the design document.

## Tasks

1. Review final design.md
2. Ensure all feedback is addressed
3. Document next steps if implementation is desired

## Design Document Checklist

- [ ] Problem statement is clear
- [ ] Proposed solution is fully described
- [ ] Trade-offs are documented
- [ ] Risks and mitigations are identified
- [ ] Confidence assessment is included
- [ ] Feedback has been addressed

This is a terminal phase. The design workflow is complete.
"""
terminal = true
